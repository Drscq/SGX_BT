Below is an example **README.md** file that you can place in your **SGX_BT** repository. It explains the purpose of the project, how to set it up, build it, run it, and troubleshoot common issues (including enclave memory limits). Feel free to adjust or expand upon it as needed.

---

# SGX_BT

This project demonstrates **bandwidth measurements** between **host memory** and an Intel SGX **enclave**. It shows how to:
1. Create an SGX enclave and configure its memory.
2. Transfer data from the host to the enclave (“Host→Enclave”).
3. Transfer data from the enclave to the host (“Enclave→Host”).
4. Measure performance (MB/s) under various buffer sizes and enclave configurations.

## Table of Contents
- [Prerequisites](#prerequisites)
- [Project Structure](#project-structure)
- [Setup and Installation](#setup-and-installation)
- [Building](#building)
- [Running](#running)
- [Enclave Memory Configuration](#enclave-memory-configuration)
- [Testing Different Buffer Sizes](#testing-different-buffer-sizes)
- [Troubleshooting](#troubleshooting)
- [License](#license)

---

## Prerequisites

1. **Hardware**:  
   - An Intel CPU that supports SGX.  
   - SGX enabled in your BIOS/UEFI.

2. **Software**:  
   - Linux environment with the Intel SGX **driver** installed.  
   - Intel SGX **SDK** and **PSW** (Platform Software) installed. On Ubuntu, for instance:  
     ```bash
     sudo apt-get update
     sudo apt-get install sgx-sdk sgx-psw
     source /opt/intel/sgxsdk/environment
     ```
   - A **C++ compiler** (e.g., `g++`) with support for C++11 or later.  
   - **AESM service** running (`sudo systemctl status aesmd`).

3. **Permissions**:  
   - Make sure you have permissions to run SGX applications (e.g., access to `/dev/sgx*` or `/dev/isgx`).

---

## Project Structure

```
SGX_BT/
├── App
│   ├── App.cpp           # Main host application
│   ├── Enclave_u.h       # Generated by sgx_edger8r (untrusted side)
│   └── Makefile          # Makefile to build the host app
├── Enclave
│   ├── Enclave.cpp       # Trusted enclave code
│   ├── Enclave.edl       # Defines ecall/ocall interfaces
│   ├── Enclave.config.xml# Enclave configuration (heap, stack sizes, etc.)
│   ├── Enclave_t.h       # Generated by sgx_edger8r (trusted side)
│   └── Makefile          # Makefile to build the enclave
├── Makefile              # (Optional) Top-level Makefile
└── README.md             # This file
```

- **Enclave.edl**: Contains definitions for `ecall_bandwidth_test` and `ecall_write_to_untrusted`.  
- **Enclave.cpp**: Implements those ecalls.  
- **App.cpp**: Allocates buffers on the host side, measures timing, and prints bandwidth results.

---

## Setup and Installation

1. **Clone or copy** this repository into your local machine:
   ```bash
   git clone https://github.com/your-username/SGX_BT.git
   ```
2. **Enter** the directory:
   ```bash
   cd SGX_BT
   ```
3. **Source** the Intel SGX SDK environment script:
   ```bash
   source /opt/intel/sgxsdk/environment
   ```
   This makes the `sgx_edger8r` and libraries available in your path.

---

## Building

### Option 1: Build with a Single Top-Level Makefile
If you have a **top-level Makefile**, simply run:
```bash
make clean
make
```
This should build both the enclave (`Enclave.signed.so`) and the host application (`app`).

### Option 2: Build Enclave and App Separately
1. **Build the enclave**:
   ```bash
   cd Enclave
   make clean
   make
   cd ..
   ```
2. **Build the host app**:
   ```bash
   cd App
   make clean
   make
   cd ..
   ```

After building, you should have:
- **`Enclave.signed.so`** (the signed enclave).
- **`app`** (the host application).

---

## Running

From the **SGX_BT** or **App** directory, run:
```bash
./app
```
You should see output similar to:
```
Host->Enclave: 1024 bytes in 0.000038 seconds (XXXXX MB/s)
Enclave->Host: 1024 bytes in 0.000009 seconds (YYYYY MB/s)
Info: SampleEnclave successfully returned.
Enter a character before exit ...
```
- **Host->Enclave** measurement times how long it takes for data to be copied into enclave memory.
- **Enclave->Host** measurement times how long it takes for data to be copied out of the enclave.

Press any key to exit.

---

## Enclave Memory Configuration

If you want to handle larger buffers (e.g., multiple megabytes), you may need to **increase** the enclave’s heap (and possibly stack) in **`Enclave.config.xml`**. For example:
```xml
<EnclaveConfiguration>
    <StackMaxSize>0x200000</StackMaxSize>      <!-- 2 MB stack -->
    <HeapMaxSize>0x2000000</HeapMaxSize>       <!-- 32 MB heap -->
    <TCSNum>4</TCSNum>
    <TCSPolicy>1</TCSPolicy>
    <DisableDebug>0</DisableDebug>
    <MiscSelect>0</MiscSelect>
    <MiscMask>0xFFFFFFFF</MiscMask>
</EnclaveConfiguration>
```
Then **rebuild** the enclave. Keep in mind that **Intel SGX** has a hardware-imposed **Enclave Page Cache (EPC)** limit (often around 128MB–256MB on modern CPUs). Exceeding that limit causes paging and drastically reduced performance.

---

## Testing Different Buffer Sizes

1. **Edit** `App.cpp` to change `data_len`:
   ```cpp
   // Example: 10 MB buffer
   const size_t data_len = 10 * 1024 * 1024;
   ```
2. **Rebuild** and run:
   ```bash
   make clean
   make
   ./app
   ```
3. Observe how the reported bandwidth changes. Large buffers may cause performance drops if they exceed the EPC size.

---

## Troubleshooting

- **`SGX_ERROR_INVALID_PARAMETER` (Error 4102)**:  
  Check that your buffer pointer and size are valid in the ecall. Ensure the `[in, size=...]` or `[out, size=...]` annotations in the EDL match the actual parameters.

- **`SGX_ERROR_ENCLAVE_LOST` (Error 3)**:  
  Usually indicates a power transition or insufficient EPC. Check that the AESM service is running and your system hasn’t suspended. Sometimes, large heaps cause paging issues that can lead to errors.

- **Runtime crash or out-of-memory**:  
  Increase `<HeapMaxSize>` or `<StackMaxSize>` in `Enclave.config.xml`, or reduce your buffer size.

- **Slow performance for large buffers**:  
  Likely EPC paging. Try chunking the data into smaller pieces or reevaluate whether all data needs to be in the enclave at once.

---

## License

This project is based on Intel’s SGX sample code and is distributed under the [Intel Sample Code License](https://software.intel.com/content/www/us/en/develop/articles/intel-sample-source-code-license-agreement.html) or a similar license. Consult the header of each source file for detailed license information.

---

**Happy experimenting with SGX bandwidth testing!** If you have any questions or run into issues, feel free to open an issue or contact the maintainers.